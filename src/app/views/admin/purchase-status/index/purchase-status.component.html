<div class="min-h-[100vh] flex px-4 md:px-10 justify-center" [@fadeInOut]>

  <div class="h-full w-full flex items-center">
    <div class="w-full mb-12 pt-12 px-4">
      <div class="pt-12 flex flex-col gap-6">
        <div class="justify-between bg-white dark:text-slate-100 dark:bg-slate-900 rounded-2xl px-5 py-7 gap-2">
          <div class="">
            <h1 class="text-2xl text-roboto font-bold dark:text-slate-200 text-gray-800">
              Purchase Status</h1>
            <p class="dark:text-slate-300">View the details of the Purchase status here.</p>
          </div>

          <div class="flex gap-2 mt-5">
            <div (click)="getThisYear()" [ngClass]="{
              'dark:bg-cosmosDarker bg-cosmosDark text-white': isAll,
              'bg-slate-200 dark:bg-slate-800 dark:text-white': !isAll
              }"
              class="flex items-center rounded-full ease-in-out hover:text-white  hover:bg-cosmosDarker transition transition-colors hover:scale-110 px-4 py-3 cursor-pointer">
              <p class="dark:text-white text-xs font-semibold">This year</p>
            </div>
            <div (click)="setWeekFilters(-1)"
              class="rounded-full bg-cosmosDark dark:bg-slate-800 hover:text-white hover:dark:bg-cosmosDarker ease-in-out hover:bg-cosmosDarker transition transition-colors hover:scale-110 px-4 py-3 cursor-pointer">
              <i class="fa fa-arrow-left text-white" aria-hidden="true"></i>
            </div>
            @for (weekFilter of weekFilters; track weekFilter.value; let index = $index) {
            <div (click)="setWeekFilters(weekFilter.fromCurrent)" [ngClass]="{
              'dark:bg-cosmosDarker bg-cosmosDark text-white': index === 1 && !isAll,
              'bg-slate-200 dark:bg-slate-800 dark:text-white': index !== 1 || isAll
              }"
              class="flex items-center  rounded-full hover:text-white hover:dark:bg-cosmosDarker ease-in-out hover:bg-cosmosDarker transition transition-colors hover:scale-110 px-3 py-2 cursor-pointer">
              <p class="text-xs font-semibold">WK {{weekFilter.value}}</p>
            </div>
            }
            <div (click)="setWeekFilters(1)"
              class="rounded-full bg-cosmosDark dark:bg-slate-800 hover:text-white  hover:dark:bg-cosmosDarker ease-in-out hover:bg-cosmosDarker transition transition-colors hover:scale-110 px-4 py-3 cursor-pointer">
              <i class="fa fa-arrow-right text-white" aria-hidden="true"></i>
            </div>
          </div>

        </div>




        @for (order of data; track order.ordernummer) {
        <div class="bg-white dark:text-slate-100 dark:bg-slate-900 rounded-2xl px-5 py-7 flex flex-col gap-2">
          <div class="mb-2 flex justify-between gap-10">
            <h2 class="text-lg text-roboto font-bold dark:text-slate-200 text-gray-800">
              {{order?.ordernummer}} ({{order.orderdatum}}) - {{order.naam}} - {{order.referentie}}
            </h2>
          </div>

          <div class="flex flex-col gap-4">

            @for(orderregel of order.inkooporderregelsIndex.nodes; track orderregel.id) {
            <div *ngIf="0 !== +orderregel.aantalbesteld" class="w-full bg-slate-100 dark:bg-slate-800 p-4 rounded-2xl">
              <div class=" flex justify-between ">

                <div>
                  <h2 class="font-semibold">{{orderregel.omschr}}</h2>
                  <p class="text-sm pt-1" *ngIf="orderregel.cdartikel">Part: {{orderregel.cdartikel}}</p>
                  <p class="text-sm pt-1" *ngIf="orderregel.bestcode">Order code: {{orderregel.bestcode}}</p>
                  <p class="text-sm pt-2 cursor-pointer w-fit" [satPopoverAnchor]="remarks" (click)="remarks.open()">
                    <span *ngIf="!orderregel?.remarks" class=" ">Add
                      Remark</span>
                    <span class="flex items-center gap-1" *ngIf="orderregel?.remarks">Remarks: {{orderregel?.remarks}}
                      <fa-icon [size]="'sm'" [icon]="faPenToSquare"></fa-icon>
                    </span>

                    <sat-popover (opened)="setRemarkValue(orderregel)" hasBackdrop verticalAlign="above"
                      horizontalAlign="center" #remarks>
                      <div class="bg-cosmosDark dark:bg-slate-950 rounded-lg flex gap-2 flex-col p-4">
                        <p class="text-white text-sm">
                          Add/Edit Remarks
                        </p>

                        <textarea [(ngModel)]="selectedRemark" (blur)="updateRemarkValue(orderregel)"
                          class="dark:text-white w-full bg-white dark:bg-slate-700 focus:border-0 rounded-2xl focus:ring-0 border-slate-300"></textarea>
                      </div>
                    </sat-popover>

                  </p>
                </div>
                <div *ngIf="0 !== +orderregel.aantalbesteld">
                  <div class="lg:w-96 text-sm grid grid-cols-2 gap-y-2">
                    <div>WH</div>
                    <div class="text-right">{{orderregel.cdmagazijn ?? '-'}}</div>

                    <div class="border-t dark:border-slate-500 border-b border-l-0 border-r-0 mt-1 py-2 ">Quantity</div>
                    <div class="border-t dark:border-slate-500 border-b border-l-0 border-r-0 mt-1 py-2 text-right">
                      {{orderregel.aantalbesteld}}</div>

                    <div class="mr-4">Price{{order.cdvaluta ? (' ('+ order.cdvaluta + ')') : ''}}:</div>
                    <div class="text-right">{{orderregel.prijs}}</div>
                  </div>
                </div>
              </div>
              <div class="w-full mx-auto mt-4">
                <div class="flex pb-3">

                  <div class="items-center flex">
                    <div (click)="updateOrderLineStatus(orderregel, 'waiting_for_approval')"
                      class="hover:cursor-pointer w-6 h-6 bg-green-600 mx-auto rounded-full text-lg text-white flex items-center">
                      @if (orderregel?.status === 'attention') {
                      <div class="w-6 h-6 bg-red-600 mx-auto rounded-full text-lg text-white flex items-center">
                        <span class="text-white text-center w-full text-sm"><i
                            class="fa fa-exclamation w-full fill-current white"></i></span>
                      </div>
                      }
                      @else if (['delivered', 'in_progress', 'waiting_for_approval'].includes(orderregel?.status ?? ''))
                      {
                      <div class="w-6 h-6 bg-green-600 mx-auto rounded-full text-lg text-white flex items-center">
                        <span class="text-white text-center w-full text-sm"><i
                            class="fa fa-check w-full fill-current white"></i></span>
                      </div>
                      } @else {
                      <div
                        class="w-6 h-6 dark:bg-slate-950 bg-slate-200 border-2 border-grey-light mx-auto rounded-full text-lg text-slate-900 dark:text-white flex items-center">
                        <span class="text-grey-darker text-sm text-center w-full">1</span>
                      </div>
                      }
                    </div>
                  </div>


                  <div class="flex-1 align-center items-center align-middle content-center flex">
                    <div class="w-full bg-grey-light rounded items-center align-middle align-center flex-1">
                      <div [ngClass]="{
                        'bg-red-600': orderregel?.status === 'attention',
                        'bg-green-600': ['delivered', 'in_progress'].includes(orderregel?.status ?? ''),
                          'dark:bg-slate-950 bg-slate-200': !orderregel?.status || orderregel?.status === 'waiting_for_approval'
                        }" class="text-xs leading-none py-1 text-center text-grey-darkest rounded "
                        style="width: 100%"></div>
                    </div>
                  </div>


                  <div (click)="updateOrderLineStatus(orderregel, 'in_progress')"
                    class="items-center flex hover:cursor-pointer ">
                    @if (orderregel?.status === 'attention') {
                    <div class="w-6 h-6 bg-red-600 mx-auto rounded-full text-lg text-white flex items-center">
                      <span class="text-white text-center w-full text-sm"><i
                          class="fa fa-exclamation w-full fill-current white"></i></span>
                    </div>
                    }
                    @else if (['delivered', 'in_progress'].includes(orderregel?.status ?? '')) {
                    <div class="w-6 h-6 bg-green-600 mx-auto rounded-full text-lg text-white flex items-center">
                      <span class="text-white text-center w-full text-sm"><i
                          class="fa fa-check w-full fill-current white"></i></span>
                    </div>
                    } @else {
                    <div
                      class="w-6 h-6 dark:bg-slate-950 bg-slate-200 border-2 border-grey-light mx-auto rounded-full text-lg text-slate-900 dark:text-white flex items-center">
                      <span class="text-grey-darker text-sm text-center w-full">2</span>
                    </div>
                    }

                  </div>

                  <div class="flex-1 align-center items-center align-middle content-center flex">
                    <div class="w-full bg-grey-light rounded items-center align-middle align-center flex-1">
                      <div class=" text-xs leading-none py-1 text-center text-grey-darkest rounded " [ngClass]="{
                          'bg-red-600': orderregel?.status === 'attention',
                          'bg-green-600': ['delivered'].includes(orderregel?.status ?? ''),
                          'dark:bg-slate-950 bg-slate-200': !orderregel?.status || ['waiting_for_approval', 'in_progress', null].includes(orderregel?.status ?? '')
                        }" style="width: 100%"></div>
                    </div>
                  </div>

                  <div class="items-center flex hover:cursor-pointer "
                    (click)="updateOrderLineStatus(orderregel, 'delivered')">
                    @if (orderregel?.status === 'attention') {
                    <div class="w-6 h-6 bg-red-600 mx-auto rounded-full text-lg text-white flex items-center">
                      <span class="text-white text-center w-full text-sm"><i
                          class="fa fa-exclamation w-full fill-current white"></i></span>
                    </div>
                    }
                    @else if (['delivered'].includes(orderregel?.status ?? '')) {
                    <div class="w-6 h-6 bg-green-600 mx-auto rounded-full text-lg text-white flex items-center">
                      <span class="text-white text-center w-full text-sm"><i
                          class="fa fa-check w-full fill-current white"></i></span>
                    </div>
                    } @else {
                    <div
                      class="w-6 h-6 dark:bg-slate-950 bg-slate-200 border-2 border-grey-light mx-auto rounded-full text-lg text-slate-900 dark:text-white flex items-center">
                      <span class="text-grey-darker text-sm text-center w-full">3</span>
                    </div>
                    }
                  </div>


                  <div class="flex-1 align-center items-center align-middle content-center flex">
                    <div class="w-full bg-grey-light rounded items-center align-middle align-center flex-1">
                      <div [ngClass]="{'bg-red-600': orderregel?.status === 'attention',
                          'dark:bg-slate-950 bg-slate-200': !orderregel?.status || ['created', 'waiting_for_approval', 'in_progress', 'delivered'].includes(orderregel?.status ?? '')
                        }" class="  text-xs leading-none py-1 text-center text-grey-darkest rounded "
                        style="width: 100%"></div>
                    </div>
                  </div>


                  <div class="items-center flex hover:cursor-pointer"
                    (click)="updateOrderLineStatus(orderregel, 'attention')">

                    @if (orderregel?.status === 'attention') {
                    <div class="w-6 h-6 bg-red-600 mx-auto rounded-full text-lg text-white flex items-center">
                      <span class="text-white text-center w-full text-sm"><i
                          class="fa fa-exclamation w-full fill-current white"></i></span>
                    </div>
                    } @else {
                    <div
                      class="w-6 h-6 dark:bg-slate-950 bg-slate-200 border-2 border-grey-light mx-auto rounded-full text-lg text-slate-900 dark:text-white flex items-center">
                      <span class="text-grey-darker text-sm text-center w-full">!</span>
                    </div>
                    }
                  </div>
                </div>

                <div class="flex text-xs content-center text-center">
                  <div class="w-[17%] text-left">
                    Waiting for approval
                  </div>

                  <div class="cursor-pointer w-[33%] text-center" [satPopoverAnchor]="shippingDate"
                    (click)="shippingDate.open()">

                    @if(orderregel.shipmentDate) {
                    In progress (shipped on {{orderregel.shipmentDate}})

                    } @else {
                    In progress
                    }
                    <sat-popover (opened)="setShippingDateValue(orderregel)" hasBackdrop verticalAlign="above"
                      horizontalAlign="center" #shippingDate>
                      <div class="bg-slate-50 dark:bg-slate-950 rounded-lg flex gap-2 flex-col p-4">
                        <p class="dark:text-white text-sm">
                          Set Shipping date
                        </p>
                        <input type="date" [(ngModel)]="selectedShippingDate" (blur)="updateShippingDate(orderregel)"
                          class=" w-full dark:text-white bg-white dark:bg-slate-800 focus:border-0 rounded-2xl focus:ring-0 border-slate-300">
                      </div>

                    </sat-popover>
                  </div>

                  <div class="w-[33%]  text-right cursor-pointer flex justify-center gap-1"
                    [satPopoverAnchor]="deliveryDate" (click)="deliveryDate.open()">
                    @if(orderregel.deliveryDate) {
                    Delivered on {{orderregel.deliveryDate}}
                    }
                    @else if(orderregel.deliveryDate) {
                    Expected delivery on {{orderregel.deliveryDate}}
                    } @else {
                    Delivered
                    }
                    <div *ngIf="orderregel.deliveryDateConfirmed"
                      class="w-4 h-4 bg-green-600 rounded-full text-lg text-white flex items-center">
                      <span class="text-white w-full text-center text-xs"><i
                          class="fa fa-check fill-current white"></i></span>
                    </div>
                    <!-- <fa-icon [size]="'xs'"
                        [icon]="faPenToSquare"></fa-icon> -->
                    <sat-popover (opened)="setDeliveryDateValue(orderregel)" hasBackdrop verticalAlign="above"
                      horizontalAlign="center" #deliveryDate>
                      <div class="bg-slate-50 dark:bg-slate-950 rounded-lg flex gap-2 flex-col p-4 gap-4">
                        <p class="dark:text-white text-sm">
                          Set Delivery date
                        </p>
                        <input type="date" [(ngModel)]="selectedDeliveryDate" (blur)="updateDeliveryDate(orderregel)"
                          class=" w-full dark:text-white bg-white dark:bg-slate-800 focus:border-0 rounded-2xl focus:ring-0 border-slate-300">
                        <label class="h-full inline-flex items-center cursor-pointer">
                          <input [id]="'confirmDeliveryDate'" type="checkbox" value="" class="sr-only peer"
                            #confirmDeliveryDate type="checkbox" [(ngModel)]="isConfirmedDeliveryDate"
                            (change)="updateDeliveryDateConfirmed(orderregel)">
                          <div
                            class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-1 peer-focus:ring-blue-300 dark:peer-focus:ring-cosmosDarker rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-cosmosDark">
                          </div>
                          <span class="ml-3 text-slate-800 dark:text-slate-200 text-sm">Delivery date confirmed</span>
                        </label>
                      </div>
                    </sat-popover>
                  </div>
                  <div class="w-[17%] text-right flex justify-end">
                    Attention
                  </div>
                </div>
              </div>
            </div>
            }

            <div class="font-semibold flex justify-end pr-4 text-base">
              Total: {{calculateTotal(order.inkooporderregelsIndex.nodes)}}
            </div>
          </div>


        </div>
        }

      </div>
    </div>
  </div>